<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Library QR Book System</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #f9f9f9;
    }
    #qr-reader {
      width: 400px !important;
      height: 400px !important;
      margin: 20px auto;
    }
    #result {
      margin-top: 1rem;
      font-size: 1.2rem;
    }
    button {
      margin: 0.5rem;
      padding: 0.5rem 1.5rem;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <h2>Scan Book QR Code</h2>
  <div id="qr-reader"></div>
  <div id="result"></div>
  <button id="checkout" style="display:none;">Check Out</button>
  <button id="return" style="display:none;">Return</button>

  <script>
    // CONFIGURE THESE!
    const SHEET_CSV_URL = 'https://script.google.com/a/macros/eayoungacademy.com/library/d/1pgNX-CBGjptd3hLNmeFGDxL3y44UkPSGb6eI-A7NfMYvGPI85MtarXoF/1';
    const APPS_SCRIPT_API = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSIHuXH2AymDJS6AptJXbndgsJunFKd0RVF1hmp5IWsg1gtR69onrgThyScblVQsztwfH-kmAbzLkGu/pubhtml?gid=0&single=true';

    let currentBook = null;
    let books = {};

    // Load Google Sheet data as CSV
    function loadBooks() {
      fetch(SHEET_CSV_URL)
        .then(r => r.text())
        .then(csv => {
          Papa.parse(csv, {
            header: true,
            complete: function(results) {
              books = {};
              results.data.forEach(row => {
                // Convert Book ID to string and trim whitespace
                if (row['Book ID']) {
                  books[String(row['Book ID']).trim()] = row;
                }
              });
              // Debug: show loaded Book IDs
              console.log("Loaded Book IDs:", Object.keys(books));
            }
          });
        });
    }

    function showActions(status) {
      document.getElementById('checkout').style.display = status === 'ready' ? '' : 'none';
      document.getElementById('return').style.display = status === 'checked_out' ? '' : 'none';
    }

    function onScanSuccess(decodedText) {
      currentBook = String(decodedText).trim();
      // Debug: show scanned value
      console.log("Scanned Book ID:", currentBook);
      if (books[currentBook]) {
        let b = books[currentBook];
        document.getElementById('result').innerText =
          `Title: ${b.Title}\nStatus: ${b.Status}\nBorrower: ${b.Borrower}`;
        showActions(b.Status);
      } else {
        document.getElementById('result').innerText = 'Book not found!';
        showActions('');
        // Debug: Show all available Book IDs
        console.log("Book not found. Available Book IDs:", Object.keys(books));
      }
    }

    // QR setup (make the box bigger)
    var scanner = new Html5QrcodeScanner('qr-reader', { fps: 10, qrbox: 350 });
    scanner.render(onScanSuccess);

    // Button Actions
    document.getElementById('checkout').onclick = function() {
      let borrower = prompt("Enter borrower's name:");
      if (!borrower) return;
      fetch(`${APPS_SCRIPT_API}?bookid=${encodeURIComponent(currentBook)}&status=checked_out&borrower=${encodeURIComponent(borrower)}`)
        .then(r => r.text())
        .then(res => {
          alert("Checked out!");
          loadBooks();
        });
    };

    document.getElementById('return').onclick = function() {
      fetch(`${APPS_SCRIPT_API}?bookid=${encodeURIComponent(currentBook)}&status=ready&borrower=`)
        .then(r => r.text())
        .then(res => {
          alert("Returned!");
          loadBooks();
        });
    };

    loadBooks();
  </script>
</body>
</html>
